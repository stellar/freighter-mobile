name: Android E2E Tests

on:
  pull_request:
    branches: [cg-integration-test]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [cg-integration-test]

env:
  NODE_VERSION: "20"
  RUBY_VERSION: 3.1.4
  JAVA_VERSION: "17"
  SKIP_COCOAPODS: "yes"
  APP_ID: "org.stellar.freighterdev"

  # Sentry configuration (disabled for E2E, but vars still needed)
  SENTRY_PROPERTIES_CONTENT: "disabled-for-e2e"
  SENTRY_DSN: "disabled-for-e2e"

  # Amplitude Analytics configuration (disabled for E2E)
  AMPLITUDE_API_KEY: "disabled-for-e2e"
  AMPLITUDE_EXPERIMENT_DEPLOYMENT_KEY: "disabled-for-e2e"

  # Android Keystores configuration (for create_keystore_file)
  ANDROID_DEV_KEYSTORE_CONTENT: ${{ secrets.ANDROID_DEV_KEYSTORE_CONTENT }}

  # Android Keystore Passwords and Aliases (for build.gradle)
  ANDROID_DEV_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_DEV_KEYSTORE_PASSWORD }}
  ANDROID_DEV_KEYSTORE_ALIAS: ${{ vars.ANDROID_DEV_KEYSTORE_ALIAS }}

  # Backend URLs
  FREIGHTER_BACKEND_V1_PROD_URL: ${{ vars.FREIGHTER_BACKEND_V1_PROD_URL }}
  FREIGHTER_BACKEND_V1_STG_URL: ${{ vars.FREIGHTER_BACKEND_V1_STG_URL }}
  FREIGHTER_BACKEND_V1_DEV_URL: ${{ vars.FREIGHTER_BACKEND_V1_DEV_URL }}
  FREIGHTER_BACKEND_V2_PROD_URL: ${{ vars.FREIGHTER_BACKEND_V2_PROD_URL }}
  FREIGHTER_BACKEND_V2_STG_URL: ${{ vars.FREIGHTER_BACKEND_V2_STG_URL }}
  FREIGHTER_BACKEND_V2_DEV_URL: ${{ vars.FREIGHTER_BACKEND_V2_DEV_URL }}

  # Wallet Kit Configuration (Production)
  WALLET_KIT_PROJECT_ID_PROD: ${{ secrets.WALLET_KIT_PROJECT_ID_PROD }}
  WALLET_KIT_MT_NAME_PROD: ${{ vars.WALLET_KIT_MT_NAME_PROD }}
  WALLET_KIT_MT_DESCRIPTION_PROD: ${{ vars.WALLET_KIT_MT_DESCRIPTION_PROD }}
  WALLET_KIT_MT_URL_PROD: ${{ vars.WALLET_KIT_MT_URL_PROD }}
  WALLET_KIT_MT_ICON_PROD: ${{ vars.WALLET_KIT_MT_ICON_PROD }}
  WALLET_KIT_MT_REDIRECT_NATIVE_PROD:
    ${{ vars.WALLET_KIT_MT_REDIRECT_NATIVE_PROD }}

  # Wallet Kit Configuration (Development)
  WALLET_KIT_PROJECT_ID_DEV: ${{ secrets.WALLET_KIT_PROJECT_ID_DEV }}
  WALLET_KIT_MT_NAME_DEV: ${{ vars.WALLET_KIT_MT_NAME_DEV }}
  WALLET_KIT_MT_DESCRIPTION_DEV: ${{ vars.WALLET_KIT_MT_DESCRIPTION_DEV }}
  WALLET_KIT_MT_URL_DEV: ${{ vars.WALLET_KIT_MT_URL_DEV }}
  WALLET_KIT_MT_ICON_DEV: ${{ vars.WALLET_KIT_MT_ICON_DEV }}
  WALLET_KIT_MT_REDIRECT_NATIVE_DEV:
    ${{ vars.WALLET_KIT_MT_REDIRECT_NATIVE_DEV }}

  # MP Collections Addresses (comma-separated list of collection addresses)
  MP_COLLECTIONS_ADDRESSES: ${{ vars.MP_COLLECTIONS_ADDRESSES }}

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest-16-cores
    timeout-minutes: 120

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h

          echo "=== Cleaning up system caches ==="
          sudo rm -rf /usr/share/dotnet 2>/dev/null || true
          sudo rm -rf /opt/ghc 2>/dev/null || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL 2>/dev/null || true
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" 2>/dev/null || true
          sudo rm -rf /opt/microsoft 2>/dev/null || true
          sudo rm -rf /opt/hostedtoolcache 2>/dev/null || true

          echo "=== Cleaning up apt cache ==="
          sudo apt-get clean || true

          echo "=== Disk space after cleanup ==="
          df -h

      - name: Make scripts executable
        run: find scripts -type f -exec chmod +x {} \;

      - name: Enable Corepack
        run: corepack enable

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Set env and create .env file
        run: |
          export ANDROID_FLAVOR="dev"
          export IS_E2E_TEST="true"
          ./scripts/gh-android-env >> $GITHUB_ENV

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: zulu
          cache: gradle

      - name: Set up Android SDK and NDK for 16KB page size alignment
        run: ./scripts/setup-android-ndk-16kb

      - name: Create Android keystore file
        run: |
          echo "Creating dev-release.keystore file..."
          mkdir -p android/keystores
          echo "$ANDROID_DEV_KEYSTORE_CONTENT" | base64 -d > android/keystores/dev-release.keystore
          ls -lh android/keystores/dev-release.keystore

      - name: Run Yarn Install
        run: yarn install --immutable

      - name: Run Post Install
        run: yarn postinstall

      - name: Clean Gradle cache before build
        run: |
          echo "=== Cleaning Gradle cache before build ==="
          cd android
          ./gradlew clean --no-daemon || true
          cd ..
          # Remove Gradle cache to free up space
          rm -rf ~/.gradle/caches/* 2>/dev/null || true
          echo "=== Disk space before build ==="
          df -h

      - name: Build Android APK for emulator
        env:
          IS_E2E_TEST: "true"
          SENTRY_DISABLE_AUTO_UPLOAD: "true"
        run: |
          cd android
          ./gradlew assembleDevRelease

          # Find APK with relative path from android directory
          APK_PATH_REL=$(find ./app/build/outputs/apk/dev/release -name "*.apk" | head -n 1)

          if [ -z "$APK_PATH_REL" ]; then
            echo "Error: APK not found in ./app/build/outputs/apk/dev/release"
            echo "Searching for APK files:"
            find ./app/build/outputs -name "*.apk" 2>/dev/null || true
            echo "Contents of ./app/build/outputs/apk/dev/release:"
            ls -la ./app/build/outputs/apk/dev/release/ 2>/dev/null || true
            exit 1
          fi

          echo "Built APK at: $APK_PATH_REL (relative to android/)"

          # Get absolute path before changing directory
          REPO_ROOT=$(pwd)/..
          APK_PATH_ABS="$REPO_ROOT/android/$APK_PATH_REL"

          # Verify the file exists
          if [ ! -f "$APK_PATH_ABS" ]; then
            echo "Error: APK file does not exist at: $APK_PATH_ABS"
            exit 1
          fi

          cd ..

          # Copy to repo root with absolute path
          cp "$APK_PATH_ABS" app.apk

          # Verify copy was successful
          if [ ! -f "app.apk" ]; then
            echo "Error: Failed to copy APK to app.apk"
            exit 1
          fi

          echo "✅ APK copied successfully: $(pwd)/app.apk"
          ls -lh app.apk
          echo "APK_PATH=$(pwd)/app.apk" >> $GITHUB_ENV

      - name: Clean up build artifacts
        run: |
          echo "=== Disk space before cleanup ==="
          df -h

          echo "=== Cleaning up Android build artifacts ==="
          # Remove build outputs we don't need (keep only the APK)
          rm -rf android/app/build/outputs/bundle
          rm -rf android/app/build/intermediates
          rm -rf android/app/build/tmp
          rm -rf android/.gradle

          echo "=== Cleaning up Gradle cache ==="
          rm -rf ~/.gradle/caches
          rm -rf ~/.gradle/daemon

          echo "=== Cleaning up node_modules build artifacts ==="
          find node_modules -name "*.o" -delete 2>/dev/null || true
          find node_modules -name "*.a" -delete 2>/dev/null || true

          echo "=== Disk space after cleanup ==="
          df -h

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-build-${{ github.run_id }}
          path: app.apk
          retention-days: 2

  test:
    name: Install and Run E2E Tests
    needs: build
    runs-on: ubuntu-latest-16-cores
    timeout-minutes: 120

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Make scripts executable
        run: find scripts -type f -exec chmod +x {} \;

      - name: Enable Corepack
        run: corepack enable

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Set up Android SDK and NDK for 16KB page size alignment
        run: ./scripts/setup-android-ndk-16kb

      - name: Install Maestro
        run: |
          curl -fsSL "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro --version

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: android-e2e-build-${{ github.run_id }}
          path: downloaded-artifacts

      - name: Run Yarn Install
        run: yarn install --immutable

      - name: Enable KVM for hardware acceleration
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Boot Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        id: emulator
        continue-on-error: false
        with:
          api-level: 33
          arch: x86_64
          profile: Nexus 6
          cores: 4
          ram-size: 4096
          force-avd-creation: true
          emulator-options:
            "-no-snapshot-save -wipe-data -no-window -gpu swiftshader_indirect
            -noaudio -no-boot-anim -partition-size 4096 -cache-size 1024 -accel
            on"
          disable-animations: true
          script:
            echo "Emulator started, boot verification will happen in next step"

      - name: Verify ADB connection
        run: |
          set -euo pipefail  # Exit on error, undefined vars, pipe failures

          echo "Verifying ADB connection to device/emulator..."
          adb devices

          # Wait for emulator to boot completely (same logic as wait-for-emulator-boot.sh)
          echo "Waiting for emulator to boot completely..."
          adb wait-for-device

          # Wait for boot completed flag
          boot_completed=""
          timeout=600  # 10 minutes
          while [ "$timeout" -gt 0 ]; do
            boot_completed=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            if [ "$boot_completed" = "1" ]; then
              break
            fi
            sleep 2
            timeout=$((timeout - 2))
          done

          if [ "$boot_completed" != "1" ]; then
            echo "❌ Error: Emulator failed to boot within 10 minutes"
            exit 1
          fi

          # Wait for ADB device to be online (retry logic)
          echo "Waiting for ADB device to be online..."
          timeout=300  # 5 minutes
          adb_ready=false
          while [ $timeout -gt 0 ]; do
            if adb devices | grep -q "device$"; then
              adb_ready=true
              break
            fi
            echo "Device not ready yet, waiting... (${timeout}s remaining)"
            sleep 5
            timeout=$((timeout - 5))
            adb devices
          done

          if [ "$adb_ready" = false ]; then
            echo "❌ Error: No Android device/emulator connected or device is not ready"
            echo "ADB devices output:"
            adb devices
            exit 1
          fi

          DEVICE_COUNT=$(adb devices | grep -c "device$" || echo "0")
          echo "✅ Found $DEVICE_COUNT connected device(s)"

      - name: Install app in Emulator
        run: |
          set -euo pipefail  # Exit on error, undefined vars, pipe failures

          # Install APK (fail if this doesn't work)
          echo "Installing APK..."
          adb install -r downloaded-artifacts/app.apk || {
            echo "❌ Error: Failed to install APK"
            exit 1
          }
          echo "✅ APK installed"

      - name: Launch app on Emulator
        run: |
          set -euo pipefail  # Exit on error, undefined vars, pipe failures

          # Launch the app on the emulator
          APP_ID="org.stellar.freighterdev"
          MAIN_ACTIVITY="org.stellar.freighterwallet.MainActivity"

          echo "=== Launching app on emulator ==="
          echo "App ID: $APP_ID"
          echo "Main Activity: $MAIN_ACTIVITY"

          # Give the Package Manager a brief moment to register the new install
          sleep 2

          # Launch the app
          adb shell am start -n "${APP_ID}/${MAIN_ACTIVITY}" -a android.intent.action.MAIN -c android.intent.category.LAUNCHER || {
            echo "❌ Error: Failed to launch app on emulator"
            echo "Checking if app is installed..."
            adb shell pm list packages | grep -i "$APP_ID" || echo "App not found in installed packages list"
            exit 1
          }
          echo "✅ App launched successfully"

      - name: Run E2E tests
        env:
          IS_E2E_TEST: "true"
          MAESTRO_DISABLE_UPDATE_CHECK: "true"
          MAESTRO_CLI_NO_ANALYTICS: "true"
        run: |
          set -euo pipefail  # Exit on error, undefined vars, pipe failures

          # Verify Maestro is installed and accessible
          MAESTRO_PATH="$HOME/.maestro/bin/maestro"
          if [ ! -f "$MAESTRO_PATH" ]; then
            echo "❌ Error: Maestro not found at $MAESTRO_PATH"
            exit 1
          fi

          # Add Maestro to PATH and verify
          export PATH="$PATH:$HOME/.maestro/bin"
          if ! command -v maestro &> /dev/null; then
            echo "❌ Error: maestro command not found in PATH"
            echo "PATH: $PATH"
            exit 1
          fi

          echo "✅ Maestro found: $(maestro --version)"

          echo "Running E2E tests..."
          yarn test:e2e || {
            echo "❌ Error: E2E tests failed"
            exit 1
          }

          echo "✅ All E2E tests passed"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-results-${{ github.run_id }}
          path: e2e-artifacts/
          retention-days: 7
          if-no-files-found: ignore
