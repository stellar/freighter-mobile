appId: org.stellar.freighterdev
tags:
  - walletconnect
  - sign-message
  - mock-dapp
  - e2e
---
# SignMessage Mock Dapp E2E Test - Happy Path
# Tests basic WalletConnect SignMessage flow with approval

- runFlow:
    file: ../onboarding/ImportFundedWallet.yaml

- runFlow:
    when:
      visible:
        id: welcome-banner-dismiss-button
    commands:
      - tapOn:
          id: welcome-banner-dismiss-button
      - extendedWaitUntil:
          visible:
            id: home-screen
          timeout: 10000

- runFlow:
    file: ./SwitchToTestnet.yaml

# Create WalletConnect session
- evalScript: |
    const res = await fetch('http://localhost:3001/session/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    output.wcUri = data.uri;
    output.sessionId = data.sessionId;

# Navigate to WalletConnect settings
- tapOn:
    id: home-screen-settings-button

- extendedWaitUntil:
    visible:
      id: settings-screen
    timeout: 5000

- tapOn:
    id: settings-walletconnect-button

- extendedWaitUntil:
    visible:
      id: walletconnect-input-screen
    timeout: 5000

# Enter WalletConnect URI
- tapOn:
    id: walletconnect-uri-input

- inputText: ${output.wcUri}

- tapOn:
    id: walletconnect-connect-button

# Accept connection proposal
- extendedWaitUntil:
    visible:
      id: session-proposal-confirm-button
    timeout: 10000

- tapOn:
    id: session-proposal-confirm-button

# Wait for connection approval
- extendedWaitUntil:
    visible:
      id: home-screen
    timeout: 10000

# Request sign message from mock dApp
- evalScript: |
    await fetch(`http://localhost:3001/session/${output.sessionId}/request/signMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: "Hello from E2E test! Please sign this message to verify your wallet.", network: "testnet" })
    });

# Wait for SignMessage modal
- extendedWaitUntil:
    visible:
      id: sign-message-title
    timeout: 10000

# Verify message and buttons are visible
- assertVisible:
    id: message-display
- assertVisible:
    id: dapp-request-confirm-button

# Approve the signature
- tapOn:
    id: dapp-request-confirm-button

# Verify we're back on home screen
- extendedWaitUntil:
    visible:
      id: home-screen
    timeout: 5000
