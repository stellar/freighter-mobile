appId: org.stellar.freighterdev
tags:
  - walletconnect
  - sign-message
  - e2e
  - mock-dapp
  - network-validation
---
# SignMessage Network Mismatch E2E Test
#
# Tests that the wallet properly validates network mismatches when a dApp
# requests a signature on a different network than the wallet is configured for.
#
# Flow:
# 1. Import funded wallet (defaults to testnet in E2E setup)
# 2. Trigger sign message request for PUBNET (different from wallet's testnet)
# 3. Verify wallet shows network mismatch error
# 4. User cannot approve on wrong network
# 5. Switch wallet to PUBNET
# 6. Same dApp request can now be signed
#
# Prerequisites:
# - IS_E2E_TEST=true in .env
# - E2E_TEST_FUNDED_RECOVERY_PHRASE set
# - Mock dApp server running on http://localhost:3001

#########################################
# SETUP: Import and Connect Wallet
#########################################

- runFlow:
    file: ../onboarding/ImportFundedWallet.yaml

- runFlow:
    when:
      visible:
        id: welcome-banner-dismiss-button
    commands:
      - tapOn:
          id: welcome-banner-dismiss-button
      - extendedWaitUntil:
          visible:
            id: home-screen
          timeout: 10000

# Ensure we're on Testnet
- runFlow:
    file: ./SwitchToTestnet.yaml

# Create session
- httpRequest:
    url: http://localhost:3001/session/create
    method: POST
    body: {}
    assignJsonPath:
      SESSION_ID: $.sessionId

- httpRequest:
    url: http://localhost:3001/session/${SESSION_ID}/wait?timeout=30000
    method: GET
    assignJsonPath:
      SESSION_TOPIC: $.topic

- log: "‚úÖ Session created on testnet wallet"

#########################################
# TEST 1: Network Mismatch - Request PUBNET on Testnet Wallet
#########################################

- log:
    "üß™ Test 1: Network Mismatch - Requesting PUBNET signature on Testnet wallet"

# Send sign message request for PUBNET (different from wallet's testnet)
- httpRequest:
    url: http://localhost:3001/session/${SESSION_ID}/request/signMessage
    method: POST
    body:
      message: "Please sign this on mainnet"
      network: "pubnet"
    assignJsonPath:
      REQUEST_ID: $.requestId

- log: "üì® Sent pubnet sign request: ${REQUEST_ID}"

#########################################
# VERIFY NETWORK MISMATCH HANDLING
#########################################

# Wait to see if modal appears (it might show an error or be rejected)
- runFlow:
    when:
      visible:
        id: sign-message-title
    timeout: 5000
    commands:
      - log: "‚ö†Ô∏è  Modal appeared - network mismatch should be handled by app"

# Since network mismatch should cause rejection, check the response
# without waiting (request should be rejected quickly)
- sleep: 2000

- httpRequest:
    url: http://localhost:3001/session/${SESSION_ID}/response?wait=false
    method: GET
    assignJsonPath:
      RESPONSE_STATUS: $.status

# The request should be rejected due to network mismatch
- assert:
    condition: ${RESPONSE_STATUS} == "rejected" || ${RESPONSE_STATUS} == "error"
    message: "Network mismatch request should be rejected or errored"

- log: "‚úÖ Network mismatch properly rejected: ${RESPONSE_STATUS}"

#########################################
# TEST 2: Switch to PUBNET and Retry
#########################################

- log: "üß™ Test 2: Switch wallet to PUBNET and retry signature"

# Go to settings to switch network
- tapOn:
    id: home-screen-settings-button

- extendedWaitUntil:
    visible:
      id: settings-screen
    timeout: 5000

# Navigate to network settings
- tapOn:
    id: settings-network-button

- extendedWaitUntil:
    visible:
      id: network-selection-sheet
    timeout: 5000

# Select PUBNET (Mainnet)
- tapOn:
    id: network-pubnet-option

- extendedWaitUntil:
    visible:
      id: home-screen
    timeout: 5000

- log: "‚úÖ Switched wallet to PUBNET"

#########################################
# Send Testnet Request (now should work on pubnet wallet at different network)
# Or test that same network works
#########################################

# Send a new sign message request for PUBNET (now wallet is also pubnet)
- httpRequest:
    url: http://localhost:3001/session/${SESSION_ID}/request/signMessage
    method: POST
    body:
      message: "Now signing on the correct network"
      network: "pubnet"
    assignJsonPath:
      REQUEST_ID_2: $.requestId

- log: "üì® Sent pubnet sign request again: ${REQUEST_ID_2}"

#########################################
# VERIFY SUCCESS ON MATCHING NETWORK
#########################################

# Wait for signing modal
- extendedWaitUntil:
    visible:
      id: sign-message-title
    timeout: 10000

- assertVisible:
    id: message-display

# Approve the signature
- tapOn:
    id: dapp-request-confirm-button

- extendedWaitUntil:
    notVisible:
      id: sign-message-title
    timeout: 10000

- log: "‚úÖ Signature approved on matching network"

# Verify signature was completed
- httpRequest:
    url: http://localhost:3001/session/${SESSION_ID}/response?wait=true&timeout=5000
    method: GET
    assignJsonPath:
      FINAL_STATUS: $.status

- assert:
    condition: ${FINAL_STATUS} == "approved"
    message: "Signature should be approved on matching network"

- log: "‚úÖ Signature verified: ${FINAL_STATUS}"

#########################################
# CLEANUP
#########################################

- httpRequest:
    url: http://localhost:3001/session/${SESSION_ID}
    method: DELETE

- log: "‚úÖ Network mismatch validation tests completed successfully!"
