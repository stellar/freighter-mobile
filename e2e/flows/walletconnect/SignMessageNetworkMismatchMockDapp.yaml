appId: org.stellar.freighterdev
tags:
  - walletconnect
  - sign-message
  - network-validation
  - e2e
---
# SignMessage Network Mismatch E2E Test
# Tests wallet network switching for WalletConnect requests

- runFlow:
    file: ../onboarding/ImportFundedWallet.yaml

- runFlow:
    when:
      visible:
        id: welcome-banner-dismiss-button
    commands:
      - tapOn:
          id: welcome-banner-dismiss-button
      - extendedWaitUntil:
          visible:
            id: home-screen
          timeout: 10000

- runFlow:
    file: ./SwitchToTestnet.yaml

# Create WalletConnect session
- evalScript: |
    const res = await fetch('http://localhost:3001/session/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    output.wcUri = data.uri;
    output.sessionId = data.sessionId;

# Navigate to WalletConnect and establish connection
- tapOn:
    id: home-screen-settings-button

- extendedWaitUntil:
    visible:
      id: settings-screen
    timeout: 5000

- tapOn:
    id: settings-walletconnect-button

- extendedWaitUntil:
    visible:
      id: walletconnect-input-screen
    timeout: 5000

- tapOn:
    id: walletconnect-uri-input

- inputText: ${output.wcUri}

- tapOn:
    id: walletconnect-connect-button

- extendedWaitUntil:
    visible:
      id: session-proposal-confirm-button
    timeout: 10000

- tapOn:
    id: session-proposal-confirm-button

- extendedWaitUntil:
    visible:
      id: home-screen
    timeout: 10000

# Test 1: Request signature on PUBNET while wallet is on Testnet
- evalScript: |
    await fetch(`http://localhost:3001/session/${output.sessionId}/request/signMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: "Please sign on mainnet", network: "pubnet" })
    });

- extendedWaitUntil:
    visible:
      id: sign-message-title
    timeout: 10000

- assertVisible:
    id: message-display

# Test 2: Switch network to PUBNET via settings
- tapOn:
    id: home-screen-settings-button

- extendedWaitUntil:
    visible:
      id: settings-screen
    timeout: 5000

- tapOn:
    id: settings-network-button

- extendedWaitUntil:
    visible:
      id: network-selection-sheet
    timeout: 5000

- tapOn:
    id: network-pubnet-option

- extendedWaitUntil:
    visible:
      id: home-screen
    timeout: 5000

# Test 3: Request signature on matching network (PUBNET)
- evalScript: |
    await fetch(`http://localhost:3001/session/${output.sessionId}/request/signMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: "Now signing on the correct network", network: "pubnet" })
    });

- extendedWaitUntil:
    visible:
      id: sign-message-title
    timeout: 10000

- tapOn:
    id: dapp-request-confirm-button

- extendedWaitUntil:
    visible:
      id: home-screen
    timeout: 5000
