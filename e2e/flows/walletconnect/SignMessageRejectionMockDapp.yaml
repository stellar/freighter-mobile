appId: org.stellar.freighterdev
tags:
  - walletconnect
  - sign-message
  - rejection
  - e2e
---
# SignMessage Rejection E2E Test
# Tests rejecting a signature request and session recovery

- runFlow:
    file: ../onboarding/ImportFundedWallet.yaml

- runFlow:
    when:
      visible:
        id: welcome-banner-dismiss-button
    commands:
      - tapOn:
          id: welcome-banner-dismiss-button
      - extendedWaitUntil:
          visible:
            id: home-screen
          timeout: 10000

- runFlow:
    file: ./SwitchToTestnet.yaml

# Create WalletConnect session
- evalScript: |
    const res = await fetch('http://localhost:3001/session/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    output.wcUri = data.uri;
    output.sessionId = data.sessionId;

# Navigate to WalletConnect and establish connection
- tapOn:
    id: home-screen-settings-button

- extendedWaitUntil:
    visible:
      id: settings-screen
    timeout: 5000

- tapOn:
    id: settings-walletconnect-button

- extendedWaitUntil:
    visible:
      id: walletconnect-input-screen
    timeout: 5000

- tapOn:
    id: walletconnect-uri-input

- inputText: ${output.wcUri}

- tapOn:
    id: walletconnect-connect-button

- extendedWaitUntil:
    visible:
      id: session-proposal-confirm-button
    timeout: 10000

- tapOn:
    id: session-proposal-confirm-button

- extendedWaitUntil:
    visible:
      id: home-screen
    timeout: 10000

# Test 1: Send first sign request and reject it
- evalScript: |
    await fetch(`http://localhost:3001/session/${output.sessionId}/request/signMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: "This request will be rejected", network: "testnet" })
    });

- extendedWaitUntil:
    visible:
      id: sign-message-title
    timeout: 10000

- assertVisible:
    id: message-display
- assertVisible:
    id: dapp-request-cancel-button

# Reject the signature
- tapOn:
    id: dapp-request-cancel-button

# Verify we're back on home screen
- extendedWaitUntil:
    visible:
      id: home-screen
    timeout: 5000

- assertVisible:
    id: home-screen

# Test 2: Send second sign request and approve it (verify session still works)
- evalScript: |
    await fetch(`http://localhost:3001/session/${output.sessionId}/request/signMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: "This request will be approved", network: "testnet" })
    });

- extendedWaitUntil:
    visible:
      id: sign-message-title
    timeout: 10000

# This time approve it
- tapOn:
    id: dapp-request-confirm-button

# Verify we're back on home screen
- extendedWaitUntil:
    visible:
      id: home-screen
    timeout: 5000
