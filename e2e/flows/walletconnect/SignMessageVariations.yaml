appId: org.stellar.freighterdev
tags:
  - walletconnect
  - sign-message
  - e2e
  - message-variations
---
# SignMessage Variations E2E Test
# Full WalletConnect session flow

- runFlow:
    file: ../onboarding/ImportFundedWallet.yaml

- runFlow:
    when:
      visible:
        id: welcome-banner-dismiss-button
    commands:
      - tapOn:
          id: welcome-banner-dismiss-button
      - extendedWaitUntil:
          visible:
            id: home-screen
          timeout: 10000

- runFlow:
    file: ./SwitchToTestnet.yaml

# Step 1: Create WalletConnect session on mock dApp
- evalScript: |
    const res = await fetch('http://localhost:3001/session/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    output.wcUri = data.uri;
    output.sessionId = data.sessionId;

# Step 2: Navigate to WalletConnect in the app
# Tap the WalletConnect button or navigate to the connection screen
- tapOn:
    id: home-screen-settings-button

- extendedWaitUntil:
    visible:
      id: settings-screen
    timeout: 5000

# Look for WalletConnect or connection option (adjust ID if needed)
- tapOn:
    id: settings-walletconnect-button

- extendedWaitUntil:
    visible:
      id: walletconnect-input-screen
    timeout: 5000

# Step 3: Paste the WalletConnect URI
- tapOn:
    id: walletconnect-uri-input

- inputText: ${output.wcUri}

- tapOn:
    id: walletconnect-connect-button

- extendedWaitUntil:
    visible:
      id: session-proposal-confirm-button
    timeout: 10000

# Step 4: Accept the connection request
- tapOn:
    id: session-proposal-confirm-button

# Step 5: Wait for session approval
- extendedWaitUntil:
    visible:
      id: home-screen
    timeout: 10000

# Step 6: Mock dApp sends sign request (after session is approved)
- evalScript: |
    await fetch(`http://localhost:3001/session/${output.sessionId}/request/signMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: "Sign this message", network: "testnet" })
    });

# Step 7: Wait for SignMessage modal to appear
- extendedWaitUntil:
    visible:
      id: sign-message-title
    timeout: 10000

# Verify message content is displayed
- assertVisible:
    id: message-display

# Step 8: Approve the signature
- tapOn:
    id: dapp-request-confirm-button

# Wait for modal to dismiss
- extendedWaitUntil:
    visible:
      id: home-screen
    timeout: 5000

# Verify we're back on home screen
- assertVisible:
    id: home-screen
