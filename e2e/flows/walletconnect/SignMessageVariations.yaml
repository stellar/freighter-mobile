appId: org.stellar.freighterdev
tags:
  - walletconnect
  - sign-message
  - e2e
  - mock-dapp
  - message-variations
---
# SignMessage Variations E2E Test
#
# Tests stellar_signMessage with different message types using the mock dApp API:
# 1. Short message
# 2. Long message
# 3. JSON formatted message
#
# Prerequisites:
# - IS_E2E_TEST=true in .env
# - E2E_TEST_FUNDED_RECOVERY_PHRASE set
# - Mock dApp server running on http://localhost:3001

#########################################
# SETUP: Import and Connect Wallet
#########################################

- runFlow:
    file: ../onboarding/ImportFundedWallet.yaml

- runFlow:
    when:
      visible:
        id: welcome-banner-dismiss-button
    commands:
      - tapOn:
          id: welcome-banner-dismiss-button
      - extendedWaitUntil:
          visible:
            id: home-screen
          timeout: 10000

- runFlow:
    file: ./SwitchToTestnet.yaml

# Create initial session
- httpRequest:
    url: http://localhost:3001/session/create
    method: POST
    body: {}
    assignJsonPath:
      SESSION_ID: $.sessionId

- httpRequest:
    url: http://localhost:3001/session/${SESSION_ID}/wait?timeout=30000
    method: GET
    assignJsonPath:
      SESSION_TOPIC: $.topic

- log: "âœ… Session ready for testing message variations"

#########################################
# TEST 1: Short Message
#########################################

- log: "ðŸ§ª Test 1: Short Message"

- httpRequest:
    url: http://localhost:3001/session/${SESSION_ID}/request/signMessage
    method: POST
    body:
      message: "Sign this short message"
      network: "testnet"

- extendedWaitUntil:
    visible:
      id: sign-message-title
    timeout: 10000

- assertVisible:
    id: message-display

- tapOn:
    id: dapp-request-confirm-button

- extendedWaitUntil:
    notVisible:
      id: sign-message-title
    timeout: 10000

- log: "âœ… Short message signed successfully"

# Small delay between requests
- sleep: 1000

#########################################
# TEST 2: Long Message
#########################################

- log: "ðŸ§ª Test 2: Long Message"

- httpRequest:
    url: http://localhost:3001/session/${SESSION_ID}/request/signMessage
    method: POST
    body:
      message:
        "This is a very long message that tests message rendering and line
        wrapping behavior in the Freighter signing sheet. It should display
        properly without truncation. This message contains multiple sentences to
        ensure that the signing sheet expands dynamically to accommodate longer
        text without requiring excessive scrolling. The user should be able to
        see the entire message at once without having to scroll through multiple
        lines."
      network: "testnet"

- extendedWaitUntil:
    visible:
      id: sign-message-title
    timeout: 10000

- assertVisible:
    id: message-display

# Verify the message display can handle the long content
- assertVisible:
    id: message-display-content-scroll

- tapOn:
    id: dapp-request-confirm-button

- extendedWaitUntil:
    notVisible:
      id: sign-message-title
    timeout: 10000

- log: "âœ… Long message signed successfully"

- sleep: 1000

#########################################
# TEST 3: JSON Message
#########################################

- log: "ðŸ§ª Test 3: JSON Formatted Message"

- httpRequest:
    url: http://localhost:3001/session/${SESSION_ID}/request/signMessage
    method: POST
    body:
      message: '{"action":"sign","timestamp":1234567890,"data":{"test":true}}'
      network: "testnet"

- extendedWaitUntil:
    visible:
      id: sign-message-title
    timeout: 10000

- assertVisible:
    id: message-display

# Verify JSON is displayed with monospace font
- assertVisible:
    id: message-display-content

- tapOn:
    id: dapp-request-confirm-button

- extendedWaitUntil:
    notVisible:
      id: sign-message-title
    timeout: 10000

- log: "âœ… JSON message signed successfully"

#########################################
# CLEANUP
#########################################

- httpRequest:
    url: http://localhost:3001/session/${SESSION_ID}
    method: DELETE

- log: "âœ… All message variation tests completed successfully!"
