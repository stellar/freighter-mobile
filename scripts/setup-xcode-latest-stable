#!/usr/bin/env bash
# Setup latest stable Xcode version for CI environments
# Selects the latest stable Xcode version, excluding beta/RC versions

set -e

# Find all beta/RC Xcode versions to identify base versions to exclude
BETA_XCODE_PATHS=$(ls -1d /Applications/Xcode*.app 2>/dev/null | grep -E "(Release_Candidate|RC|beta|Beta)" || true)

# Extract base version numbers (major.minor) from beta/RC versions
EXCLUDED_BASE_VERSIONS=""
if [ -n "$BETA_XCODE_PATHS" ]; then
  echo "Found beta/RC Xcode versions:"
  for BETA_XCODE_PATH in $BETA_XCODE_PATHS; do
    BETA_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$BETA_XCODE_PATH/Contents/Info.plist" 2>/dev/null || echo "")
    if [ -n "$BETA_VERSION" ]; then
      # Extract major.minor version (e.g., 26.2 from 26.2.0 or 26.2_beta_2)
      BASE_VERSION=$(echo "$BETA_VERSION" | sed -E 's/^([0-9]+\.[0-9]+).*/\1/')
      echo "  - $BETA_XCODE_PATH (Version: $BETA_VERSION, Base: $BASE_VERSION)"
      EXCLUDED_BASE_VERSIONS="${EXCLUDED_BASE_VERSIONS}${BASE_VERSION} "
    fi
  done
  echo "Excluding all paths with base versions: $EXCLUDED_BASE_VERSIONS"
fi

# Find all stable Xcode versions (exclude Release_Candidate, RC, beta, Beta)
XCODE_PATHS=$(ls -1d /Applications/Xcode*.app 2>/dev/null | grep -v -E "(Release_Candidate|RC|beta|Beta)" || true)

if [ -z "$XCODE_PATHS" ]; then
  echo "Error: No stable Xcode installation found in /Applications"
  echo "Available Xcode versions:"
  ls -1 /Applications | grep -i Xcode || true
  exit 1
fi

# Find the latest stable Xcode by sorting versions, excluding those with beta/RC base versions
LATEST_XCODE=""
LATEST_VERSION=""

TEMP_FILE=$(mktemp)
for XCODE_PATH in $XCODE_PATHS; do
  VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$XCODE_PATH/Contents/Info.plist" 2>/dev/null || echo "0")
  if [ "$VERSION" != "0" ]; then
    # Extract major.minor version for comparison
    BASE_VERSION=$(echo "$VERSION" | sed -E 's/^([0-9]+\.[0-9]+).*/\1/')
    
    # Check if this base version should be excluded
    SHOULD_EXCLUDE=false
    for EXCLUDED_BASE in $EXCLUDED_BASE_VERSIONS; do
      if [ "$BASE_VERSION" = "$EXCLUDED_BASE" ]; then
        echo "Excluding $XCODE_PATH (Version: $VERSION, Base: $BASE_VERSION matches excluded base version)"
        SHOULD_EXCLUDE=true
        break
      fi
    done
    
    if [ "$SHOULD_EXCLUDE" = "false" ]; then
      printf "%s\t%s\n" "$VERSION" "$XCODE_PATH" >> "$TEMP_FILE"
    fi
  fi
done

# Sort by version (descending) and get the first one
LATEST=$(sort -V -r -k1 "$TEMP_FILE" | head -n 1)
rm -f "$TEMP_FILE"

if [ -z "$LATEST" ]; then
  echo "Error: Failed to determine latest Xcode version"
  exit 1
fi

LATEST_VERSION=$(echo "$LATEST" | cut -f1)
LATEST_XCODE=$(echo "$LATEST" | cut -f2)

echo "Selected Xcode: $LATEST_XCODE (Version: $LATEST_VERSION)"
sudo xcode-select -s "$LATEST_XCODE"
